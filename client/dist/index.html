<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0">
    <title>学習アプリ - 算数・国語問題</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent; /* タップ時のハイライト無効化 */
            -webkit-touch-callout: none; /* 長押し時のメニュー無効化 */
            -webkit-user-select: none; /* テキスト選択無効化 */
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem;
            overflow-x: hidden; /* 横スクロール防止 */
            position: relative;
        }

        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 24px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
            padding: 2rem;
            backdrop-filter: blur(10px);
        }

        .welcome-card {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border-radius: 20px;
            padding: 3rem 2rem;
            text-align: center;
            margin-bottom: 2rem;
            box-shadow: 0 15px 35px rgba(79, 172, 254, 0.3);
        }

        .feature-card {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 2rem;
        }

        .feature-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        /* スマホでのホバーエフェクト無効化 */
        @media (max-width: 768px) {
            .primary-button:hover,
            .feature-card:hover,
            .choice-button:hover,
            .numpad button:hover {
                transform: none;
                box-shadow: initial;
            }
        }

        .primary-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 1rem 2rem;
            font-weight: 600;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 15px rgba(102, 126, 234, 0.3);
            width: 100%;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            touch-action: manipulation; /* タップ時の拡大・スクロール防止 */
        }

        .primary-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 25px rgba(102, 126, 234, 0.4);
        }

        .primary-button:active {
            transform: translateY(0);
        }

        .primary-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .secondary-button {
            background: #f7fafc;
            color: #4a5568;
            border: 2px solid #e2e8f0;
            padding: 0.8rem 1.5rem;
            font-size: 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            touch-action: manipulation;
        }
        
        .secondary-button:hover:not(:disabled) {
            border-color: #cbd5e0;
            background: #edf2f7;
        }
        
        .secondary-button:active {
            transform: translateY(0);
            background: #e2e8f0;
        }

        .input-field {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 1rem;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.06);
            width: 100%;
            margin-bottom: 1rem;
        }

        .input-field:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            outline: none;
        }

        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
            margin-bottom: 1rem;
        }

        .hidden {
            display: none;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }
        
        .math-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }



        .question-card {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .numpad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            max-width: 280px;
            margin: 0 auto;
        }

        .numpad button {
            padding: 0.8rem;
            font-size: 1.3rem;
            border: none;
            border-radius: 8px;
            background: #f7fafc;
            cursor: pointer;
            transition: all 0.3s ease;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            touch-action: manipulation;
        }

        .numpad button:hover:not(:disabled) {
            background: #e2e8f0;
            transform: translateY(-2px);
        }

        .numpad button:active {
            transform: translateY(0);
            background: #e2e8f0;
        }
        
        .numpad button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* スマホ画面でのレスポンシブ対応 */
        @media (max-width: 768px) {
            body {
                padding: 1rem;
                overflow-x: hidden;
                position: fixed;
                width: 100%;
                height: 100%;
            }
            
            .app-container {
                padding: 0.5rem;
                max-height: 100vh;
                overflow-y: auto;
            }
            
            .grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .math-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .math-container {
                padding: 0.5rem;
            }
            
            .numpad {
                position: relative;
                background: white;
                padding: 0.6rem;
                border-radius: 12px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.1);
                margin-top: 0.3rem;
                gap: 0.3rem;
            }
            
            .numpad button {
                padding: 0.6rem;
                font-size: 1.1rem;
            }
            
            .feature-card {
                margin-bottom: 0.5rem;
                padding: 0.8rem;
            }
            
            .question-area {
                margin-bottom: 0.5rem;
            }
            
            .question-card {
                padding: 0.8rem !important;
                margin: 0.3rem 0 !important;
            }
            
            .question-card h2 {
                font-size: 1.2rem;
                margin: 0 0 0.5rem 0;
            }
            
            .welcome-card {
                padding: 0.8rem !important;
                margin: 0.3rem 0 !important;
            }
            
            .welcome-card h1 {
                font-size: 1.4rem;
                margin: 0 !important;
            }
            
            .choice-button {
                padding: 0.8rem;
                margin: 0.3rem 0;
                font-size: 0.9rem;
            }
            
            .primary-button {
                padding: 0.8rem 1.5rem;
                font-size: 0.9rem;
                margin: 0.5rem 0;
            }
            
            .numpad {
                padding: 0.8rem;
                margin-top: 0.5rem;
            }
            
            .app-container {
                padding: 0.5rem;
            }
            
            .math-container {
                padding: 0.5rem;
            }
        }

        .choice-button {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 1rem;
            margin: 0.5rem 0;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            text-align: left;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            touch-action: manipulation;
        }

        .choice-button:hover {
            border-color: #667eea;
            background: #f8faff;
        }

        .choice-button.selected {
            border-color: #667eea;
            background: #f8faff;
        }

        .choice-button:active {
            transform: translateY(0);
            background: #f8faff;
        }
        
        .choice-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const API_BASE = '/api';

        function App() {
            const [currentUser, setCurrentUser] = useState(null);
            const [currentPage, setCurrentPage] = useState('home');
            const [currentQuestion, setCurrentQuestion] = useState(null);
            const [userAnswer, setUserAnswer] = useState('');
            const [selectedAnswer, setSelectedAnswer] = useState('');
            const [showResult, setShowResult] = useState(false);
            const [lastResult, setLastResult] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [success, setSuccess] = useState('');
            
            // ページ遷移時に状態をリセット
            useEffect(() => {
                setCurrentQuestion(null);
                setUserAnswer('');
                setSelectedAnswer('');
                setShowResult(false);
                setLastResult(null);
            }, [currentPage]);
            
            // 問題重複回避のため、最近の問題を記録
            const [recentQuestions, setRecentQuestions] = useState([]);
            const [usedQuestionTexts, setUsedQuestionTexts] = useState(new Set());
            const maxRecentQuestions = 10; // 最大10問を記録
            
            // Load user data from localStorage on page load
            useEffect(() => {
                const savedUser = localStorage.getItem('currentUser');
                if (savedUser) {
                    try {
                        const user = JSON.parse(savedUser);
                        setCurrentUser(user);
                        // showMessage(`おかえりなさい、${user.name}さん！`); // メッセージ削除
                    } catch (e) {
                        console.error('Failed to load user data:', e);
                        localStorage.removeItem('currentUser');
                        localStorage.removeItem('userProgress');
                    }
                }
            }, []);

            const showMessage = (message, type = 'success') => {
                if (type === 'error') {
                    setError(message);
                    setTimeout(() => setError(''), 5000);
                } else {
                    setSuccess(message);
                    setTimeout(() => setSuccess(''), 3000);
                }
            };

            const createUser = async (name, password) => {
                try {
                    setLoading(true);
                    
                    // Create user via API
                    const response = await fetch('/api/users', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            name: name,
                            password: password,
                            totalScore: 0,
                            mathScore: 0,
                            languageScore: 0,
                            currentRank: 'bronze',
                            rewards: []
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error('ユーザー作成に失敗しました');
                    }
                    
                    const user = await response.json();
                    
                    // Save to localStorage for persistence
                    localStorage.setItem('currentUser', JSON.stringify(user));
                    
                    setCurrentUser(user);
                    // showMessage(`${user.name}さん、ようこそ！`); // メッセージ削除
                } catch (err) {
                    console.error('User creation error:', err);
                    showMessage('ユーザー作成に失敗しました', 'error');
                } finally {
                    setLoading(false);
                }
            };

            const loginUser = async (name, password) => {
                try {
                    setLoading(true);
                    
                    // Login via API
                    const response = await fetch('/api/login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            name: name,
                            password: password
                        })
                    });
                    
                    if (!response.ok) {
                        if (response.status === 401) {
                            throw new Error('名前またはパスワードが正しくありません');
                        }
                        throw new Error('ログインに失敗しました');
                    }
                    
                    const user = await response.json();
                    
                    // Save to localStorage for persistence
                    localStorage.setItem('currentUser', JSON.stringify(user));
                    
                    setCurrentUser(user);
                    // showMessage(`おかえりなさい、${user.name}さん！`); // メッセージ削除
                } catch (err) {
                    console.error('Login error:', err);
                    showMessage(err.message || 'ログインに失敗しました', 'error');
                } finally {
                    setLoading(false);
                }
            };

            // 算数問題データ（小学1年生レベル）
            const mathQuestions = [
                { question: "1 + 1 = ?", answer: "2", explanation: "1と1を足すと2になります" },
                { question: "2 + 1 = ?", answer: "3", explanation: "2と1を足すと3になります" },
                { question: "3 + 2 = ?", answer: "5", explanation: "3と2を足すと5になります" },
                { question: "4 + 3 = ?", answer: "7", explanation: "4と3を足すと7になります" },
                { question: "5 + 2 = ?", answer: "7", explanation: "5と2を足すと7になります" },
                { question: "6 + 1 = ?", answer: "7", explanation: "6と1を足すと7になります" },
                { question: "3 + 3 = ?", answer: "6", explanation: "3と3を足すと6になります" },
                { question: "4 + 4 = ?", answer: "8", explanation: "4と4を足すと8になります" },
                { question: "5 + 5 = ?", answer: "10", explanation: "5と5を足すと10になります" },
                { question: "8 - 3 = ?", answer: "5", explanation: "8から3を引くと5になります" },
                { question: "9 - 4 = ?", answer: "5", explanation: "9から4を引くと5になります" },
                { question: "10 - 5 = ?", answer: "5", explanation: "10から5を引くと5になります" },
                { question: "7 - 2 = ?", answer: "5", explanation: "7から2を引くと5になります" },
                { question: "6 - 1 = ?", answer: "5", explanation: "6から1を引くと5になります" },
                { question: "9 - 3 = ?", answer: "6", explanation: "9から3を引くと6になります" }
            ];

            // 国語問題データ（小学1年生レベル、ひらがな・カタカナのみ）
            const languageQuestions = [
                {
                    question: "「いぬ」をカタカナで書くと？",
                    choices: ["イヌ", "イノ", "ウニ", "ヌイ", "ニウ"],
                    correctAnswer: "イヌ",
                    explanation: "いぬはカタカナでイヌと書きます"
                },
                {
                    question: "「ねこ」をカタカナで書くと？",
                    choices: ["ネコ", "ネカ", "コネ", "ケノ", "ノケ"],
                    correctAnswer: "ネコ",
                    explanation: "ねこはカタカナでネコと書きます"
                },
                {
                    question: "「うさぎ」をカタカナで書くと？",
                    choices: ["ウサギ", "ウシギ", "サウギ", "ギウサ", "ウギサ"],
                    correctAnswer: "ウサギ",
                    explanation: "うさぎはカタカナでウサギと書きます"
                },
                {
                    question: "「でんしゃ」をカタカナで書くと？",
                    choices: ["デンシャ", "デンサ", "シャデン", "テンシャ", "デシャン"],
                    correctAnswer: "デンシャ",
                    explanation: "でんしゃはカタカナでデンシャと書きます"
                },
                {
                    question: "「かばん」をカタカナで書くと？",
                    choices: ["カバン", "カバ", "バンカ", "ガバン", "カパン"],
                    correctAnswer: "カバン",
                    explanation: "かばんはカタカナでカバンと書きます"
                },
                {
                    question: "「りんご」をカタカナで書くと？",
                    choices: ["リンゴ", "リンガ", "ゴリン", "ゴンリ", "ンリゴ"],
                    correctAnswer: "リンゴ",
                    explanation: "りんごはカタカナでリンゴと書きます"
                },
                {
                    question: "「ばなな」をカタカナで書くと？",
                    choices: ["バナナ", "バナノ", "ナバナ", "ナナバ", "バノナ"],
                    correctAnswer: "バナナ",
                    explanation: "ばななはカタカナでバナナと書きます"
                },
                {
                    question: "「ぱん」をカタカナで書くと？",
                    choices: ["パン", "パナ", "ンパ", "ナパ", "パノ"],
                    correctAnswer: "パン",
                    explanation: "ぱんはカタカナでパンと書きます"
                },
                {
                    question: "「みかん」をカタカナで書くと？",
                    choices: ["ミカン", "ミカノ", "カミン", "ンミカ", "ミノカ"],
                    correctAnswer: "ミカン",
                    explanation: "みかんはカタカナでミカンと書きます"
                },
                {
                    question: "「ぼーる」をカタカナで書くと？",
                    choices: ["ボール", "ボーラ", "ルボー", "ーボル", "ボルー"],
                    correctAnswer: "ボール",
                    explanation: "ぼーるはカタカナでボールと書きます"
                }
            ];

            // Gemini APIキーの設定（実際の環境では環境変数から取得）
            const GEMINI_API_KEY = 'AIzaSyCm6oV13XP7d218nQxDeg8xGHhG6jT8Z50'; // 実際のAPIキーに置き換える
            
            // デバッグ情報
            console.log('GEMINI_API_KEY configured:', GEMINI_API_KEY ? 'Yes' : 'No');
            console.log('API Key length:', GEMINI_API_KEY ? GEMINI_API_KEY.length : 0);

            const generateQuestion = async (type, difficulty = 1) => {
                try {
                    setLoading(true);
                    
                    let question;
                    
                    // 最初にデータベースから問題を取得を試行
                    try {
                        const response = await fetch(`/api/question/${type}?difficulty=${difficulty}`);
                        if (response.ok) {
                            const apiQuestion = await response.json();
                            console.log(`Using database question (${apiQuestion.source}):`, apiQuestion);
                            // データベース問題の構造を統一
                            question = {
                                id: apiQuestion.id,
                                type: apiQuestion.type,
                                question: apiQuestion.question,
                                answer: apiQuestion.answer,
                                options: apiQuestion.choices || [],
                                choices: apiQuestion.choices || [],
                                difficulty: apiQuestion.difficulty,
                                source: apiQuestion.source
                            };
                        } else {
                            throw new Error('Database query failed');
                        }
                    } catch (dbError) {
                        console.warn('Database unavailable, using predefined questions:', dbError.message);
                        
                        // フォールバック: 事前定義問題を使用
                        if (type === 'math') {
                            // 重複を避けて事前定義問題を選択
                            let availableQuestions = mathQuestions.filter(q => 
                                !usedQuestionTexts.has(q.question)
                            );
                            if (availableQuestions.length === 0) {
                                availableQuestions = mathQuestions; // Reset if all used
                                setUsedQuestionTexts(new Set()); // Clear history
                            }
                            const randomQuestion = availableQuestions[Math.floor(Math.random() * availableQuestions.length)];
                            question = {
                                id: `math_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                                type: 'math',
                                question: randomQuestion.question,
                                answer: randomQuestion.answer,
                                explanation: randomQuestion.explanation,
                                difficulty: difficulty,
                                source: 'predefined'
                            };
                            console.log('Using predefined math question:', question);
                        } else if (type === 'language') {
                            // 重複を避けて事前定義問題を選択
                            let availableQuestions = languageQuestions.filter(q => 
                                !usedQuestionTexts.has(q.question)
                            );
                            if (availableQuestions.length === 0) {
                                availableQuestions = languageQuestions; // Reset if all used
                                setUsedQuestionTexts(new Set()); // Clear history
                            }
                            const randomQuestion = availableQuestions[Math.floor(Math.random() * availableQuestions.length)];
                            question = {
                                id: `lang_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                                type: 'language',
                                question: randomQuestion.question,
                                options: randomQuestion.choices,
                                answer: randomQuestion.correctAnswer,
                                explanation: randomQuestion.explanation,
                                difficulty: difficulty,
                                source: 'predefined'
                            };
                            console.log('Using predefined language question:', question);
                        } else {
                            throw new Error('無効な問題タイプです');
                        }
                    }
                    
                    // Save the generated question to database for answer submission
                    try {
                        const saveResponse = await fetch('/api/questions', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                id: question.id,
                                type: question.type,
                                question: question.question,
                                answer: question.answer,
                                choices: question.options || [],
                                difficulty: question.difficulty
                            })
                        });
                        
                        if (saveResponse.ok) {
                            console.log('Question saved to database:', question.id);
                            // 保存完了を確認するため少し待機
                            await new Promise(resolve => setTimeout(resolve, 100));
                        } else {
                            console.warn('Failed to save question to database, but continuing with frontend-only mode');
                        }
                    } catch (saveError) {
                        console.error('Error saving question to database:', saveError);
                        // サーバーエラーでも問題を続行する（フォールバック）
                        console.warn('Continuing with frontend-only mode due to server error');
                    }
                    
                    // 最近の問題リストを更新
                    setRecentQuestions(prev => {
                        const newRecent = [...prev, question];
                        if (newRecent.length > maxRecentQuestions) {
                            newRecent.shift(); // 古い問題を削除
                        }
                        return newRecent;
                    });
                    
                    setCurrentQuestion(question);
                    setUserAnswer('');
                    setSelectedAnswer('');
                    setShowResult(false);
                    setLastResult(null);
                    
                    // showMessage('小学1年生レベルの問題を生成しました！'); // メッセージ削除
                } catch (err) {
                    console.error('Error generating question:', err);
                    showMessage('問題生成に失敗しました: ' + err.message, 'error');
                    
                    // フォールバック: 予め定義された問題を使用
                    console.log('Using fallback questions...');
                    let fallbackQuestion;
                    
                    if (type === 'math') {
                        const randomQuestion = mathQuestions[Math.floor(Math.random() * mathQuestions.length)];
                        fallbackQuestion = {
                            id: `math_${Date.now()}`,
                            type: 'math',
                            question: randomQuestion.question,
                            answer: randomQuestion.answer,
                            explanation: randomQuestion.explanation,
                            difficulty: difficulty
                        };
                    } else if (type === 'language') {
                        const randomQuestion = languageQuestions[Math.floor(Math.random() * languageQuestions.length)];
                        fallbackQuestion = {
                            id: `lang_${Date.now()}`,
                            type: 'language',
                            question: randomQuestion.question,
                            options: randomQuestion.choices,
                            answer: randomQuestion.correctAnswer,
                            explanation: randomQuestion.explanation,
                            difficulty: difficulty
                        };
                    }
                    
                    if (fallbackQuestion) {
                        setCurrentQuestion(fallbackQuestion);
                        setUserAnswer('');
                        setSelectedAnswer('');
                        setShowResult(false);
                        setLastResult(null);
                        // showMessage('小学1年生レベルの問題を用意しました'); // メッセージ削除
                    }
                } finally {
                    setLoading(false);
                }
            };

            // AI問題生成関数（算数）
            const generateMathQuestionWithAI = async (difficulty = 1) => {
                const prompt = `小学1年生レベルの算数問題を1つ作成してください。

要件:
- 数字は1から10までの範囲
- 足し算か引き算のみ
- 結果は0から20の範囲内
- 日本語で問題文を作成
- 答えは数字のみ

以下のJSON形式で回答してください:
{
    "question": "問題文 (例: 3 + 4 = ?)",
    "answer": "正解の数字",
    "explanation": "解説 (例: 3と4を足すと7になります)"
}`;

                const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=' + GEMINI_API_KEY, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [
                            {
                                parts: [
                                    {
                                        text: prompt
                                    }
                                ]
                            }
                        ],
                        generationConfig: {
                            temperature: 0.7,
                            topK: 20,
                            topP: 0.8,
                            maxOutputTokens: 200
                        }
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Math API Error:', errorData);
                    throw new Error(`AI問題生成に失敗しました: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                console.log('Math AI Response:', data);
                const text = data.candidates[0].content.parts[0].text;
                
                // JSON部分を抽出
                const jsonMatch = text.match(/\{[\s\S]*\}/);
                if (!jsonMatch) {
                    throw new Error('AI応答の解析に失敗しました');
                }
                
                const questionData = JSON.parse(jsonMatch[0]);
                
                return {
                    id: `math_${Date.now()}`,
                    type: 'math',
                    question: questionData.question,
                    answer: questionData.answer,
                    explanation: questionData.explanation,
                    difficulty: difficulty
                };
            };

            // AI問題生成関数（国語）
            const generateLanguageQuestionWithAI = async (difficulty = 1) => {
                const prompt = `小学1年生レベルの国語問題を1つ作成してください。

要件:
- ひらがな・カタカナのみ（漢字は使用禁止）
- ひらがなをカタカナに変換する問題
- 動物、食べ物、日用品などの簡単な単語
- 5つの選択肢を提供
- 正解は1つだけ

以下のJSON形式で回答してください:
{
    "question": "問題文 (例: 「いぬ」をカタカナで書くと？)",
    "choices": ["選択肢1", "選択肢2", "選択肢3", "選択肢4", "選択肢5"],
    "correctAnswer": "正解の選択肢",
    "explanation": "解説 (例: いぬはカタカナでイヌと書きます)"
}`;

                const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=' + GEMINI_API_KEY, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [
                            {
                                parts: [
                                    {
                                        text: prompt
                                    }
                                ]
                            }
                        ],
                        generationConfig: {
                            temperature: 0.7,
                            topK: 20,
                            topP: 0.8,
                            maxOutputTokens: 300
                        }
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Language API Error:', errorData);
                    throw new Error(`AI問題生成に失敗しました: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                console.log('Language AI Response:', data);
                const text = data.candidates[0].content.parts[0].text;
                
                // JSON部分を抽出
                const jsonMatch = text.match(/\{[\s\S]*\}/);
                if (!jsonMatch) {
                    throw new Error('AI応答の解析に失敗しました');
                }
                
                const questionData = JSON.parse(jsonMatch[0]);
                
                return {
                    id: `lang_${Date.now()}`,
                    type: 'language',
                    question: questionData.question,
                    options: questionData.choices,
                    answer: questionData.correctAnswer,
                    explanation: questionData.explanation,
                    difficulty: difficulty
                };
            };



            const submitAnswer = async (answer) => {
                try {
                    setLoading(true);
                    
                    // Ensure user exists in the server before submitting answer
                    if (!currentUser || !currentUser.id) {
                        throw new Error('ユーザー情報が見つかりません');
                    }
                    
                    // Check if user exists on server, if not create it
                    console.log('Checking user existence for ID:', currentUser.id);
                    const checkUserResponse = await fetch(`/api/users/${currentUser.id}`);
                    console.log('Check user response status:', checkUserResponse.status);
                    
                    if (!checkUserResponse.ok) {
                        console.log('User does not exist on server, creating...');
                        // User doesn't exist on server, create it
                        const createUserResponse = await fetch('/api/users', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                name: currentUser.name,
                                totalScore: currentUser.totalScore || 0,
                                mathScore: currentUser.mathScore || 0,
                                languageScore: currentUser.languageScore || 0,
                                currentRank: currentUser.currentRank || 'bronze',
                                rewards: currentUser.rewards || []
                            })
                        });
                        
                        if (createUserResponse.ok) {
                            const newUser = await createUserResponse.json();
                            setCurrentUser(newUser);
                            localStorage.setItem('currentUser', JSON.stringify(newUser));
                            console.log('Recreated user on server:', newUser);
                        } else {
                            console.error('Failed to create user on server:', createUserResponse.status);
                        }
                    } else {
                        console.log('User exists on server');
                    }
                    
                    // Ensure question exists in database before submitting answer
                    console.log('Ensuring question exists in database...');
                    const ensureQuestionResponse = await fetch('/api/questions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            id: currentQuestion.id,
                            type: currentQuestion.type,
                            question: currentQuestion.question,
                            answer: currentQuestion.answer,
                            choices: currentQuestion.options || [],
                            difficulty: currentQuestion.difficulty || 1
                        })
                    });
                    
                    if (ensureQuestionResponse.ok) {
                        console.log('Question ensured in database');
                    } else {
                        console.warn('Failed to ensure question in database, but continuing');
                    }
                    
                    // Submit answer to database via API
                    const response = await fetch('/api/answers', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            userId: currentUser.id,
                            questionId: currentQuestion.id,
                            userAnswer: answer
                        })
                    });
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('API Error Response:', errorText);
                        console.error('Question ID:', currentQuestion.id);
                        console.error('User ID:', currentUser.id);
                        throw new Error(`回答の送信に失敗しました: ${response.status} - ${errorText}`);
                    }
                    
                    const result = await response.json();
                    
                    // Update current user with the returned user data
                    setCurrentUser(result.user);
                    
                    // Save updated user to localStorage
                    localStorage.setItem('currentUser', JSON.stringify(result.user));
                    
                    setLastResult(result);
                    setShowResult(true);
                    
                    if (result && result.answer && result.answer.isCorrect) {
                        // showMessage(`正解！ ${result.scoreIncrement || 10}ポイント獲得`); // メッセージ削除
                        
                        // Check for rank up
                        if (result.rankUp) {
                            // showMessage('ランクアップしました！'); // メッセージ削除
                        }
                        
                        // Check for new rewards
                        if (result.newRewards && result.newRewards.length > 0) {
                            result.newRewards.forEach(reward => {
                                // showMessage(`新しい特典を獲得: ${reward.name} ${reward.icon}`); // メッセージ削除
                            });
                        }
                    } else {
                        // showMessage('不正解です', 'error'); // メッセージ削除
                    }
                } catch (err) {
                    console.error('Submit answer error:', err);
                    console.error('Error details:', err.message);
                    showMessage('回答処理に失敗しました: ' + err.message, 'error');
                } finally {
                    setLoading(false);
                }
            };
            
            const logoutUser = () => {
                localStorage.removeItem('currentUser');
                localStorage.removeItem('userProgress');
                setCurrentUser(null);
                setCurrentPage('home');
                setCurrentQuestion(null);
                setUserAnswer('');
                setSelectedAnswer('');
                setShowResult(false);
                setLastResult(null);
                // showMessage('ログアウトしました'); // メッセージ削除
            };
            
            const resetUserData = () => {
                if (currentUser && window.confirm('本当にデータをリセットしますか？この操作は取り消せません。')) {
                    const resetUser = {
                        ...currentUser,
                        totalScore: 0,
                        mathScore: 0,
                        languageScore: 0,
                        rank: '初心者',
                        currentRank: 'bronze',
                        rewards: []
                    };
                    
                    setCurrentUser(resetUser);
                    localStorage.setItem('currentUser', JSON.stringify(resetUser));
                    localStorage.setItem('userProgress', JSON.stringify({
                        userId: currentUser.id,
                        totalScore: 0,
                        mathScore: 0,
                        languageScore: 0,
                        rank: '初心者',
                        answeredQuestions: [],
                        lastUpdated: new Date().toISOString()
                    }));
                    
                    showMessage('データをリセットしました');
                }
            };

            const HomePage = () => {
                const [userName, setUserName] = useState('');
                const [password, setPassword] = useState('');
                const [isLogin, setIsLogin] = useState(false);

                const handleSubmit = (e) => {
                    e.preventDefault();
                    if (userName.trim() && password.trim()) {
                        if (isLogin) {
                            loginUser(userName.trim(), password.trim());
                        } else {
                            createUser(userName.trim(), password.trim());
                        }
                    }
                };

                if (currentUser) {
                    return (
                        <div>
                            <div className="welcome-card">
                                <h1>おかえりなさい、{currentUser.name}さん！</h1>
                                <p>今日も一緒に学習しましょう ✨</p>
                            </div>
                            
                            <div className="stats-card">
                                <h2>{currentUser.name}</h2>
                                <p>総合スコア: {currentUser.totalScore}</p>
                                <p>ランク: {currentUser.rank}</p>
                            </div>

                            <div className="grid">
                                <div className="feature-card">
                                    <h3>🧮 算数</h3>
                                    <p>スコア: {currentUser.mathScore}</p>
                                    <p>テンキーを使って計算問題を解きましょう</p>
                                    <button className="primary-button" onClick={() => setCurrentPage('math')}>
                                        算数問題を解く
                                    </button>
                                </div>
                                
                                <div className="feature-card">
                                    <h3>📚 国語</h3>
                                    <p>スコア: {currentUser.languageScore}</p>
                                    <p>5つの選択肢から正しい答えを選びましょう</p>
                                    <button className="primary-button" onClick={() => setCurrentPage('language')}>
                                        国語問題を解く
                                    </button>
                                </div>
                            </div>
                            
                            <div className="feature-card" style={{marginTop: '2rem', textAlign: 'center'}}>
                                <button className="secondary-button" onClick={logoutUser}>
                                    ログアウト
                                </button>
                            </div>
                        </div>
                    );
                }

                return (
                    <div>
                        <div className="welcome-card">
                            <h1>学習アプリへようこそ！</h1>
                            <p>算数と国語の問題で楽しく学習しましょう 🎓</p>
                        </div>

                        <div className="feature-card" style={{maxWidth: '500px', margin: '0 auto'}}>
                            <h2>👤 {isLogin ? 'ログイン' : '新規ユーザー登録'}</h2>
                            <p>{isLogin ? '名前とパスワードを入力してログインしてください' : '名前と4桁のパスワードを入力してください'}</p>
                            
                            <form onSubmit={handleSubmit}>
                                <input 
                                    type="text" 
                                    value={userName}
                                    onChange={(e) => setUserName(e.target.value)}
                                    placeholder="あなたの名前を入力してください"
                                    className="input-field"
                                    required
                                />
                                <input 
                                    type="password" 
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    placeholder="4桁のパスワードを入力してください"
                                    className="input-field"
                                    maxLength="4"
                                    pattern="[0-9]{4}"
                                    title="4桁の数字を入力してください"
                                    required
                                />
                                <button type="submit" className="primary-button" disabled={loading}>
                                    {loading ? (isLogin ? 'ログイン中...' : '登録中...') : (isLogin ? 'ログイン' : '新規登録')}
                                </button>
                            </form>
                            
                            <div style={{marginTop: '1rem', textAlign: 'center'}}>
                                <button 
                                    type="button" 
                                    className="secondary-button"
                                    onClick={() => setIsLogin(!isLogin)}
                                >
                                    {isLogin ? '新規ユーザー登録' : '既存ユーザーでログイン'}
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };

            const MathPage = () => {
                const addNumber = (num) => {
                    setUserAnswer(prev => prev + num);
                };

                const clearAnswer = () => {
                    setUserAnswer('');
                };

                const backspace = () => {
                    setUserAnswer(prev => prev.slice(0, -1));
                };

                const handleSubmit = () => {
                    if (userAnswer.trim() && !loading && !showResult) {
                        submitAnswer(userAnswer.trim());
                    }
                };

                return (
                    <div className="math-container">
                        <div className="welcome-card" style={{padding: '0.5rem', margin: '0.2rem 0'}}>
                            <h1 style={{margin: '0', fontSize: '1.3rem'}}>🧮 算数問題</h1>
                        </div>

                        <div className="math-grid">
                            <div className="feature-card" style={{padding: '0.8rem', margin: '0.2rem 0'}}>
                                <h3 style={{margin: '0 0 0.3rem 0', fontSize: '1.1rem'}}>問題</h3>
                                {!currentQuestion ? (
                                    <button className="primary-button" onClick={() => generateQuestion('math', 1)}>
                                        {loading ? '生成中...' : '新しい問題を生成'}
                                    </button>
                                ) : (
                                    <div className="question-area">
                                        <div className="question-card" style={{padding: '0.8rem', margin: '0.2rem 0'}}>
                                            <h2 style={{margin: '0 0 0.3rem 0', fontSize: '1.2rem'}}>{currentQuestion.question}</h2>
                                            <div style={{fontSize: '1.1rem', margin: '0.3rem 0', border: '2px solid #e2e8f0', padding: '0.4rem', borderRadius: '8px', minHeight: '1.8rem'}}>
                                                {userAnswer || '答えを入力してください'}
                                            </div>
                                            
                                            {showResult && (
                                                <div style={{marginTop: '0.5rem', padding: '0.8rem', backgroundColor: lastResult?.answer?.isCorrect ? '#f0fff4' : '#fee', borderRadius: '8px'}}>
                                                    <h3 style={{margin: '0 0 0.3rem 0', fontSize: '1.1rem'}}>{lastResult?.answer?.isCorrect ? '正解！' : '不正解'}</h3>
                                                    <p style={{margin: '0.2rem 0', fontSize: '0.9rem'}}>正解: {currentQuestion.answer}</p>
                                                    {lastResult?.answer?.isCorrect && <p style={{margin: '0.2rem 0', fontSize: '0.9rem'}}>獲得ポイント: {lastResult.scoreIncrement}</p>}
                                                    <button className="primary-button" onClick={() => generateQuestion('math', 1)} style={{marginTop: '0.5rem', padding: '0.6rem 1rem', fontSize: '0.9rem'}}>
                                                        次の問題
                                                    </button>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                )}
                            </div>

                            <div className="feature-card" style={{padding: '0.8rem', margin: '0.2rem 0'}}>
                                <div className="numpad">
                                    {[1,2,3,4,5,6,7,8,9,'C',0,'⌫'].map(btn => (
                                        <button 
                                            key={btn} 
                                            onClick={() => {
                                                if (btn === 'C') clearAnswer();
                                                else if (btn === '⌫') backspace();
                                                else addNumber(btn.toString());
                                            }}
                                            disabled={showResult}
                                        >
                                            {btn}
                                        </button>
                                    ))}
                                </div>
                                <button className="primary-button" onClick={handleSubmit} disabled={!userAnswer || loading || showResult} style={{marginTop: '0.5rem', padding: '0.6rem 1rem', fontSize: '0.9rem', opacity: (!userAnswer || loading || showResult) ? '0.5' : '1'}}>
                                    {loading ? '送信中...' : '回答する'}
                                </button>
                            </div>
                        </div>

                        <button className="primary-button" onClick={() => setCurrentPage('home')} style={{marginTop: '0.5rem', padding: '0.6rem 1rem', fontSize: '0.9rem'}}>
                            ホームに戻る
                        </button>
                    </div>
                );
            };

            const LanguagePage = () => {
                const handleSubmit = () => {
                    if (selectedAnswer && !loading && !showResult) {
                        submitAnswer(selectedAnswer);
                    }
                };

                return (
                    <div>
                        <div className="welcome-card" style={{padding: '1rem', margin: '0.5rem 0'}}>
                            <h1 style={{margin: '0', fontSize: '1.5rem'}}>📚 国語問題</h1>
                        </div>

                        <div className="feature-card" style={{padding: '1rem', margin: '0.5rem 0'}}>
                            <h3 style={{margin: '0 0 0.5rem 0', fontSize: '1.2rem'}}>問題</h3>
                            {!currentQuestion ? (
                                <button className="primary-button" onClick={() => generateQuestion('language', 1)}>
                                    {loading ? '生成中...' : '新しい問題を生成'}
                                </button>
                            ) : (
                                <div className="question-card" style={{padding: '1rem', margin: '0.5rem 0'}}>
                                    <h2 style={{margin: '0 0 0.5rem 0', fontSize: '1.3rem'}}>{currentQuestion.question}</h2>
                                    
                                    {(currentQuestion.options || currentQuestion.choices || []).map((option, index) => (
                                        <button
                                            key={index}
                                            className={`choice-button ${selectedAnswer === option ? 'selected' : ''}`}
                                            onClick={() => setSelectedAnswer(option)}
                                            disabled={showResult}
                                        >
                                            {option}
                                        </button>
                                    ))}
                                    
                                    <button className="primary-button" onClick={handleSubmit} disabled={!selectedAnswer || loading || showResult} style={{marginTop: '1rem', opacity: (!selectedAnswer || loading || showResult) ? '0.5' : '1'}}>
                                        {loading ? '送信中...' : '回答する'}
                                    </button>
                                    
                                    {showResult && (
                                        <div style={{marginTop: '1rem', padding: '1rem', backgroundColor: lastResult?.answer?.isCorrect ? '#f0fff4' : '#fee', borderRadius: '8px'}}>
                                            <h3>{lastResult?.answer?.isCorrect ? '正解！' : '不正解'}</h3>
                                            <p>正解: {currentQuestion.answer}</p>
                                            {lastResult?.answer?.isCorrect && <p>獲得ポイント: {lastResult.scoreIncrement}</p>}
                                            <button className="primary-button" onClick={() => generateQuestion('language', 1)} style={{marginTop: '1rem'}}>
                                                次の問題
                                            </button>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>

                        <button className="primary-button" onClick={() => setCurrentPage('home')} style={{marginTop: '2rem'}}>
                            ホームに戻る
                        </button>
                    </div>
                );
            };

            const renderPage = () => {
                switch(currentPage) {
                    case 'math': return <MathPage />;
                    case 'language': return <LanguagePage />;
                    default: return <HomePage />;
                }
            };

            return (
                <div className="app-container">
                    {renderPage()}
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>