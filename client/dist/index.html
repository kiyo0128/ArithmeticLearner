<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0">
    <title>å­¦ç¿’ã‚¢ãƒ—ãƒª - ç®—æ•°ãƒ»å›½èªå•é¡Œ</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent; /* ã‚¿ãƒƒãƒ—æ™‚ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆç„¡åŠ¹åŒ– */
            -webkit-touch-callout: none; /* é•·æŠ¼ã—æ™‚ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç„¡åŠ¹åŒ– */
            -webkit-user-select: none; /* ãƒ†ã‚­ã‚¹ãƒˆé¸æŠç„¡åŠ¹åŒ– */
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem;
            overflow-x: hidden; /* æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é˜²æ­¢ */
            position: relative;
        }

        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 24px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
            padding: 2rem;
            backdrop-filter: blur(10px);
        }

        .welcome-card {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border-radius: 20px;
            padding: 3rem 2rem;
            text-align: center;
            margin-bottom: 2rem;
            box-shadow: 0 15px 35px rgba(79, 172, 254, 0.3);
        }

        .feature-card {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 2rem;
        }

        .feature-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        /* ã‚¹ãƒãƒ›ã§ã®ãƒ›ãƒãƒ¼ã‚¨ãƒ•ã‚§ã‚¯ãƒˆç„¡åŠ¹åŒ– */
        @media (max-width: 768px) {
            .primary-button:hover,
            .feature-card:hover,
            .choice-button:hover,
            .numpad button:hover {
                transform: none;
                box-shadow: initial;
            }
        }

        .primary-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 1rem 2rem;
            font-weight: 600;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 15px rgba(102, 126, 234, 0.3);
            width: 100%;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            touch-action: manipulation; /* ã‚¿ãƒƒãƒ—æ™‚ã®æ‹¡å¤§ãƒ»ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é˜²æ­¢ */
        }

        .primary-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 25px rgba(102, 126, 234, 0.4);
        }

        .primary-button:active {
            transform: translateY(0);
        }

        .primary-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .secondary-button {
            background: #f7fafc;
            color: #4a5568;
            border: 2px solid #e2e8f0;
            padding: 0.8rem 1.5rem;
            font-size: 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            touch-action: manipulation;
        }
        
        .secondary-button:hover:not(:disabled) {
            border-color: #cbd5e0;
            background: #edf2f7;
        }
        
        .secondary-button:active {
            transform: translateY(0);
            background: #e2e8f0;
        }

        .input-field {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 1rem;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.06);
            width: 100%;
            margin-bottom: 1rem;
        }

        .input-field:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            outline: none;
        }

        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
            margin-bottom: 1rem;
        }

        .hidden {
            display: none;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }
        
        .math-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }



        .question-card {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .numpad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            max-width: 280px;
            margin: 0 auto;
        }

        .numpad button {
            padding: 0.8rem;
            font-size: 1.3rem;
            border: none;
            border-radius: 8px;
            background: #f7fafc;
            cursor: pointer;
            transition: all 0.3s ease;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            touch-action: manipulation;
        }

        .numpad button:hover:not(:disabled) {
            background: #e2e8f0;
            transform: translateY(-2px);
        }

        .numpad button:active {
            transform: translateY(0);
            background: #e2e8f0;
        }
        
        .numpad button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* ã‚¹ãƒãƒ›ç”»é¢ã§ã®ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
        @media (max-width: 768px) {
            body {
                padding: 1rem;
                overflow-x: hidden;
                position: fixed;
                width: 100%;
                height: 100%;
            }
            
            .app-container {
                padding: 0.5rem;
                max-height: 100vh;
                overflow-y: auto;
            }
            
            .grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .math-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .math-container {
                padding: 0.5rem;
            }
            
            .numpad {
                position: relative;
                background: white;
                padding: 0.6rem;
                border-radius: 12px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.1);
                margin-top: 0.3rem;
                gap: 0.3rem;
            }
            
            .numpad button {
                padding: 0.6rem;
                font-size: 1.1rem;
            }
            
            .feature-card {
                margin-bottom: 0.5rem;
                padding: 0.8rem;
            }
            
            .question-area {
                margin-bottom: 0.5rem;
            }
            
            .question-card {
                padding: 0.8rem !important;
                margin: 0.3rem 0 !important;
            }
            
            .question-card h2 {
                font-size: 1.2rem;
                margin: 0 0 0.5rem 0;
            }
            
            .welcome-card {
                padding: 0.8rem !important;
                margin: 0.3rem 0 !important;
            }
            
            .welcome-card h1 {
                font-size: 1.4rem;
                margin: 0 !important;
            }
            
            .choice-button {
                padding: 0.8rem;
                margin: 0.3rem 0;
                font-size: 0.9rem;
            }
            
            .primary-button {
                padding: 0.8rem 1.5rem;
                font-size: 0.9rem;
                margin: 0.5rem 0;
            }
            
            .numpad {
                padding: 0.8rem;
                margin-top: 0.5rem;
            }
            
            .app-container {
                padding: 0.5rem;
            }
            
            .math-container {
                padding: 0.5rem;
            }
        }

        .choice-button {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 1rem;
            margin: 0.5rem 0;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            text-align: left;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            touch-action: manipulation;
        }

        .choice-button:hover {
            border-color: #667eea;
            background: #f8faff;
        }

        .choice-button.selected {
            border-color: #667eea;
            background: #f8faff;
        }

        .choice-button:active {
            transform: translateY(0);
            background: #f8faff;
        }
        
        .choice-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const API_BASE = '/api';

        function App() {
            const [currentUser, setCurrentUser] = useState(null);
            const [currentPage, setCurrentPage] = useState('home');
            const [currentQuestion, setCurrentQuestion] = useState(null);
            const [userAnswer, setUserAnswer] = useState('');
            const [selectedAnswer, setSelectedAnswer] = useState('');
            const [showResult, setShowResult] = useState(false);
            const [lastResult, setLastResult] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [success, setSuccess] = useState('');
            
            // ãƒšãƒ¼ã‚¸é·ç§»æ™‚ã«çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            useEffect(() => {
                setCurrentQuestion(null);
                setUserAnswer('');
                setSelectedAnswer('');
                setShowResult(false);
                setLastResult(null);
            }, [currentPage]);
            
            // å•é¡Œé‡è¤‡å›é¿ã®ãŸã‚ã€æœ€è¿‘ã®å•é¡Œã‚’è¨˜éŒ²
            const [recentQuestions, setRecentQuestions] = useState([]);
            const [usedQuestionTexts, setUsedQuestionTexts] = useState(new Set());
            const maxRecentQuestions = 10; // æœ€å¤§10å•ã‚’è¨˜éŒ²
            
            // Load user data from localStorage on page load
            useEffect(() => {
                const savedUser = localStorage.getItem('currentUser');
                if (savedUser) {
                    try {
                        const user = JSON.parse(savedUser);
                        setCurrentUser(user);
                        // showMessage(`ãŠã‹ãˆã‚Šãªã•ã„ã€${user.name}ã•ã‚“ï¼`); // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‰Šé™¤
                    } catch (e) {
                        console.error('Failed to load user data:', e);
                        localStorage.removeItem('currentUser');
                        localStorage.removeItem('userProgress');
                    }
                }
            }, []);

            const showMessage = (message, type = 'success') => {
                if (type === 'error') {
                    setError(message);
                    setTimeout(() => setError(''), 5000);
                } else {
                    setSuccess(message);
                    setTimeout(() => setSuccess(''), 3000);
                }
            };

            const createUser = async (name, password) => {
                try {
                    setLoading(true);
                    
                    // Create user via API
                    const response = await fetch('/api/users', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            name: name,
                            password: password,
                            totalScore: 0,
                            mathScore: 0,
                            languageScore: 0,
                            currentRank: 'bronze',
                            rewards: []
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                    
                    const user = await response.json();
                    
                    // Save to localStorage for persistence
                    localStorage.setItem('currentUser', JSON.stringify(user));
                    
                    setCurrentUser(user);
                    // showMessage(`${user.name}ã•ã‚“ã€ã‚ˆã†ã“ãï¼`); // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‰Šé™¤
                } catch (err) {
                    console.error('User creation error:', err);
                    showMessage('ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                } finally {
                    setLoading(false);
                }
            };

            const loginUser = async (name, password) => {
                try {
                    setLoading(true);
                    
                    // Login via API
                    const response = await fetch('/api/login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            name: name,
                            password: password
                        })
                    });
                    
                    if (!response.ok) {
                        if (response.status === 401) {
                            throw new Error('åå‰ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
                        }
                        throw new Error('ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                    
                    const user = await response.json();
                    
                    // Save to localStorage for persistence
                    localStorage.setItem('currentUser', JSON.stringify(user));
                    
                    setCurrentUser(user);
                    // showMessage(`ãŠã‹ãˆã‚Šãªã•ã„ã€${user.name}ã•ã‚“ï¼`); // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‰Šé™¤
                } catch (err) {
                    console.error('Login error:', err);
                    showMessage(err.message || 'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                } finally {
                    setLoading(false);
                }
            };

            // ç®—æ•°å•é¡Œãƒ‡ãƒ¼ã‚¿ï¼ˆå°å­¦1å¹´ç”Ÿãƒ¬ãƒ™ãƒ«ï¼‰
            const mathQuestions = [
                { question: "1 + 1 = ?", answer: "2", explanation: "1ã¨1ã‚’è¶³ã™ã¨2ã«ãªã‚Šã¾ã™" },
                { question: "2 + 1 = ?", answer: "3", explanation: "2ã¨1ã‚’è¶³ã™ã¨3ã«ãªã‚Šã¾ã™" },
                { question: "3 + 2 = ?", answer: "5", explanation: "3ã¨2ã‚’è¶³ã™ã¨5ã«ãªã‚Šã¾ã™" },
                { question: "4 + 3 = ?", answer: "7", explanation: "4ã¨3ã‚’è¶³ã™ã¨7ã«ãªã‚Šã¾ã™" },
                { question: "5 + 2 = ?", answer: "7", explanation: "5ã¨2ã‚’è¶³ã™ã¨7ã«ãªã‚Šã¾ã™" },
                { question: "6 + 1 = ?", answer: "7", explanation: "6ã¨1ã‚’è¶³ã™ã¨7ã«ãªã‚Šã¾ã™" },
                { question: "3 + 3 = ?", answer: "6", explanation: "3ã¨3ã‚’è¶³ã™ã¨6ã«ãªã‚Šã¾ã™" },
                { question: "4 + 4 = ?", answer: "8", explanation: "4ã¨4ã‚’è¶³ã™ã¨8ã«ãªã‚Šã¾ã™" },
                { question: "5 + 5 = ?", answer: "10", explanation: "5ã¨5ã‚’è¶³ã™ã¨10ã«ãªã‚Šã¾ã™" },
                { question: "8 - 3 = ?", answer: "5", explanation: "8ã‹ã‚‰3ã‚’å¼•ãã¨5ã«ãªã‚Šã¾ã™" },
                { question: "9 - 4 = ?", answer: "5", explanation: "9ã‹ã‚‰4ã‚’å¼•ãã¨5ã«ãªã‚Šã¾ã™" },
                { question: "10 - 5 = ?", answer: "5", explanation: "10ã‹ã‚‰5ã‚’å¼•ãã¨5ã«ãªã‚Šã¾ã™" },
                { question: "7 - 2 = ?", answer: "5", explanation: "7ã‹ã‚‰2ã‚’å¼•ãã¨5ã«ãªã‚Šã¾ã™" },
                { question: "6 - 1 = ?", answer: "5", explanation: "6ã‹ã‚‰1ã‚’å¼•ãã¨5ã«ãªã‚Šã¾ã™" },
                { question: "9 - 3 = ?", answer: "6", explanation: "9ã‹ã‚‰3ã‚’å¼•ãã¨6ã«ãªã‚Šã¾ã™" }
            ];

            // å›½èªå•é¡Œãƒ‡ãƒ¼ã‚¿ï¼ˆå°å­¦1å¹´ç”Ÿãƒ¬ãƒ™ãƒ«ã€ã²ã‚‰ãŒãªãƒ»ã‚«ã‚¿ã‚«ãƒŠã®ã¿ï¼‰
            const languageQuestions = [
                {
                    question: "ã€Œã„ã¬ã€ã‚’ã‚«ã‚¿ã‚«ãƒŠã§æ›¸ãã¨ï¼Ÿ",
                    choices: ["ã‚¤ãƒŒ", "ã‚¤ãƒ", "ã‚¦ãƒ‹", "ãƒŒã‚¤", "ãƒ‹ã‚¦"],
                    correctAnswer: "ã‚¤ãƒŒ",
                    explanation: "ã„ã¬ã¯ã‚«ã‚¿ã‚«ãƒŠã§ã‚¤ãƒŒã¨æ›¸ãã¾ã™"
                },
                {
                    question: "ã€Œã­ã“ã€ã‚’ã‚«ã‚¿ã‚«ãƒŠã§æ›¸ãã¨ï¼Ÿ",
                    choices: ["ãƒã‚³", "ãƒã‚«", "ã‚³ãƒ", "ã‚±ãƒ", "ãƒã‚±"],
                    correctAnswer: "ãƒã‚³",
                    explanation: "ã­ã“ã¯ã‚«ã‚¿ã‚«ãƒŠã§ãƒã‚³ã¨æ›¸ãã¾ã™"
                },
                {
                    question: "ã€Œã†ã•ãã€ã‚’ã‚«ã‚¿ã‚«ãƒŠã§æ›¸ãã¨ï¼Ÿ",
                    choices: ["ã‚¦ã‚µã‚®", "ã‚¦ã‚·ã‚®", "ã‚µã‚¦ã‚®", "ã‚®ã‚¦ã‚µ", "ã‚¦ã‚®ã‚µ"],
                    correctAnswer: "ã‚¦ã‚µã‚®",
                    explanation: "ã†ã•ãã¯ã‚«ã‚¿ã‚«ãƒŠã§ã‚¦ã‚µã‚®ã¨æ›¸ãã¾ã™"
                },
                {
                    question: "ã€Œã§ã‚“ã—ã‚ƒã€ã‚’ã‚«ã‚¿ã‚«ãƒŠã§æ›¸ãã¨ï¼Ÿ",
                    choices: ["ãƒ‡ãƒ³ã‚·ãƒ£", "ãƒ‡ãƒ³ã‚µ", "ã‚·ãƒ£ãƒ‡ãƒ³", "ãƒ†ãƒ³ã‚·ãƒ£", "ãƒ‡ã‚·ãƒ£ãƒ³"],
                    correctAnswer: "ãƒ‡ãƒ³ã‚·ãƒ£",
                    explanation: "ã§ã‚“ã—ã‚ƒã¯ã‚«ã‚¿ã‚«ãƒŠã§ãƒ‡ãƒ³ã‚·ãƒ£ã¨æ›¸ãã¾ã™"
                },
                {
                    question: "ã€Œã‹ã°ã‚“ã€ã‚’ã‚«ã‚¿ã‚«ãƒŠã§æ›¸ãã¨ï¼Ÿ",
                    choices: ["ã‚«ãƒãƒ³", "ã‚«ãƒ", "ãƒãƒ³ã‚«", "ã‚¬ãƒãƒ³", "ã‚«ãƒ‘ãƒ³"],
                    correctAnswer: "ã‚«ãƒãƒ³",
                    explanation: "ã‹ã°ã‚“ã¯ã‚«ã‚¿ã‚«ãƒŠã§ã‚«ãƒãƒ³ã¨æ›¸ãã¾ã™"
                },
                {
                    question: "ã€Œã‚Šã‚“ã”ã€ã‚’ã‚«ã‚¿ã‚«ãƒŠã§æ›¸ãã¨ï¼Ÿ",
                    choices: ["ãƒªãƒ³ã‚´", "ãƒªãƒ³ã‚¬", "ã‚´ãƒªãƒ³", "ã‚´ãƒ³ãƒª", "ãƒ³ãƒªã‚´"],
                    correctAnswer: "ãƒªãƒ³ã‚´",
                    explanation: "ã‚Šã‚“ã”ã¯ã‚«ã‚¿ã‚«ãƒŠã§ãƒªãƒ³ã‚´ã¨æ›¸ãã¾ã™"
                },
                {
                    question: "ã€Œã°ãªãªã€ã‚’ã‚«ã‚¿ã‚«ãƒŠã§æ›¸ãã¨ï¼Ÿ",
                    choices: ["ãƒãƒŠãƒŠ", "ãƒãƒŠãƒ", "ãƒŠãƒãƒŠ", "ãƒŠãƒŠãƒ", "ãƒãƒãƒŠ"],
                    correctAnswer: "ãƒãƒŠãƒŠ",
                    explanation: "ã°ãªãªã¯ã‚«ã‚¿ã‚«ãƒŠã§ãƒãƒŠãƒŠã¨æ›¸ãã¾ã™"
                },
                {
                    question: "ã€Œã±ã‚“ã€ã‚’ã‚«ã‚¿ã‚«ãƒŠã§æ›¸ãã¨ï¼Ÿ",
                    choices: ["ãƒ‘ãƒ³", "ãƒ‘ãƒŠ", "ãƒ³ãƒ‘", "ãƒŠãƒ‘", "ãƒ‘ãƒ"],
                    correctAnswer: "ãƒ‘ãƒ³",
                    explanation: "ã±ã‚“ã¯ã‚«ã‚¿ã‚«ãƒŠã§ãƒ‘ãƒ³ã¨æ›¸ãã¾ã™"
                },
                {
                    question: "ã€Œã¿ã‹ã‚“ã€ã‚’ã‚«ã‚¿ã‚«ãƒŠã§æ›¸ãã¨ï¼Ÿ",
                    choices: ["ãƒŸã‚«ãƒ³", "ãƒŸã‚«ãƒ", "ã‚«ãƒŸãƒ³", "ãƒ³ãƒŸã‚«", "ãƒŸãƒã‚«"],
                    correctAnswer: "ãƒŸã‚«ãƒ³",
                    explanation: "ã¿ã‹ã‚“ã¯ã‚«ã‚¿ã‚«ãƒŠã§ãƒŸã‚«ãƒ³ã¨æ›¸ãã¾ã™"
                },
                {
                    question: "ã€Œã¼ãƒ¼ã‚‹ã€ã‚’ã‚«ã‚¿ã‚«ãƒŠã§æ›¸ãã¨ï¼Ÿ",
                    choices: ["ãƒœãƒ¼ãƒ«", "ãƒœãƒ¼ãƒ©", "ãƒ«ãƒœãƒ¼", "ãƒ¼ãƒœãƒ«", "ãƒœãƒ«ãƒ¼"],
                    correctAnswer: "ãƒœãƒ¼ãƒ«",
                    explanation: "ã¼ãƒ¼ã‚‹ã¯ã‚«ã‚¿ã‚«ãƒŠã§ãƒœãƒ¼ãƒ«ã¨æ›¸ãã¾ã™"
                }
            ];

            // Gemini APIã‚­ãƒ¼ã®è¨­å®šï¼ˆå®Ÿéš›ã®ç’°å¢ƒã§ã¯ç’°å¢ƒå¤‰æ•°ã‹ã‚‰å–å¾—ï¼‰
            const GEMINI_API_KEY = 'AIzaSyCm6oV13XP7d218nQxDeg8xGHhG6jT8Z50'; // å®Ÿéš›ã®APIã‚­ãƒ¼ã«ç½®ãæ›ãˆã‚‹
            
            // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
            console.log('GEMINI_API_KEY configured:', GEMINI_API_KEY ? 'Yes' : 'No');
            console.log('API Key length:', GEMINI_API_KEY ? GEMINI_API_KEY.length : 0);

            const generateQuestion = async (type, difficulty = 1) => {
                try {
                    setLoading(true);
                    
                    let question;
                    
                    // æœ€åˆã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰å•é¡Œã‚’å–å¾—ã‚’è©¦è¡Œ
                    try {
                        const response = await fetch(`/api/question/${type}?difficulty=${difficulty}`);
                        if (response.ok) {
                            const apiQuestion = await response.json();
                            console.log(`Using database question (${apiQuestion.source}):`, apiQuestion);
                            // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å•é¡Œã®æ§‹é€ ã‚’çµ±ä¸€
                            question = {
                                id: apiQuestion.id,
                                type: apiQuestion.type,
                                question: apiQuestion.question,
                                answer: apiQuestion.answer,
                                options: apiQuestion.choices || [],
                                choices: apiQuestion.choices || [],
                                difficulty: apiQuestion.difficulty,
                                source: apiQuestion.source
                            };
                        } else {
                            throw new Error('Database query failed');
                        }
                    } catch (dbError) {
                        console.warn('Database unavailable, using predefined questions:', dbError.message);
                        
                        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: äº‹å‰å®šç¾©å•é¡Œã‚’ä½¿ç”¨
                        if (type === 'math') {
                            // é‡è¤‡ã‚’é¿ã‘ã¦äº‹å‰å®šç¾©å•é¡Œã‚’é¸æŠ
                            let availableQuestions = mathQuestions.filter(q => 
                                !usedQuestionTexts.has(q.question)
                            );
                            if (availableQuestions.length === 0) {
                                availableQuestions = mathQuestions; // Reset if all used
                                setUsedQuestionTexts(new Set()); // Clear history
                            }
                            const randomQuestion = availableQuestions[Math.floor(Math.random() * availableQuestions.length)];
                            question = {
                                id: `math_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                                type: 'math',
                                question: randomQuestion.question,
                                answer: randomQuestion.answer,
                                explanation: randomQuestion.explanation,
                                difficulty: difficulty,
                                source: 'predefined'
                            };
                            console.log('Using predefined math question:', question);
                        } else if (type === 'language') {
                            // é‡è¤‡ã‚’é¿ã‘ã¦äº‹å‰å®šç¾©å•é¡Œã‚’é¸æŠ
                            let availableQuestions = languageQuestions.filter(q => 
                                !usedQuestionTexts.has(q.question)
                            );
                            if (availableQuestions.length === 0) {
                                availableQuestions = languageQuestions; // Reset if all used
                                setUsedQuestionTexts(new Set()); // Clear history
                            }
                            const randomQuestion = availableQuestions[Math.floor(Math.random() * availableQuestions.length)];
                            question = {
                                id: `lang_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                                type: 'language',
                                question: randomQuestion.question,
                                options: randomQuestion.choices,
                                answer: randomQuestion.correctAnswer,
                                explanation: randomQuestion.explanation,
                                difficulty: difficulty,
                                source: 'predefined'
                            };
                            console.log('Using predefined language question:', question);
                        } else {
                            throw new Error('ç„¡åŠ¹ãªå•é¡Œã‚¿ã‚¤ãƒ—ã§ã™');
                        }
                    }
                    
                    // Save the generated question to database for answer submission
                    try {
                        const saveResponse = await fetch('/api/questions', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                id: question.id,
                                type: question.type,
                                question: question.question,
                                answer: question.answer,
                                choices: question.options || [],
                                difficulty: question.difficulty
                            })
                        });
                        
                        if (saveResponse.ok) {
                            console.log('Question saved to database:', question.id);
                            // ä¿å­˜å®Œäº†ã‚’ç¢ºèªã™ã‚‹ãŸã‚å°‘ã—å¾…æ©Ÿ
                            await new Promise(resolve => setTimeout(resolve, 100));
                        } else {
                            console.warn('Failed to save question to database, but continuing with frontend-only mode');
                        }
                    } catch (saveError) {
                        console.error('Error saving question to database:', saveError);
                        // ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ã§ã‚‚å•é¡Œã‚’ç¶šè¡Œã™ã‚‹ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
                        console.warn('Continuing with frontend-only mode due to server error');
                    }
                    
                    // æœ€è¿‘ã®å•é¡Œãƒªã‚¹ãƒˆã‚’æ›´æ–°
                    setRecentQuestions(prev => {
                        const newRecent = [...prev, question];
                        if (newRecent.length > maxRecentQuestions) {
                            newRecent.shift(); // å¤ã„å•é¡Œã‚’å‰Šé™¤
                        }
                        return newRecent;
                    });
                    
                    setCurrentQuestion(question);
                    setUserAnswer('');
                    setSelectedAnswer('');
                    setShowResult(false);
                    setLastResult(null);
                    
                    // showMessage('å°å­¦1å¹´ç”Ÿãƒ¬ãƒ™ãƒ«ã®å•é¡Œã‚’ç”Ÿæˆã—ã¾ã—ãŸï¼'); // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‰Šé™¤
                } catch (err) {
                    console.error('Error generating question:', err);
                    showMessage('å•é¡Œç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message, 'error');
                    
                    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: äºˆã‚å®šç¾©ã•ã‚ŒãŸå•é¡Œã‚’ä½¿ç”¨
                    console.log('Using fallback questions...');
                    let fallbackQuestion;
                    
                    if (type === 'math') {
                        const randomQuestion = mathQuestions[Math.floor(Math.random() * mathQuestions.length)];
                        fallbackQuestion = {
                            id: `math_${Date.now()}`,
                            type: 'math',
                            question: randomQuestion.question,
                            answer: randomQuestion.answer,
                            explanation: randomQuestion.explanation,
                            difficulty: difficulty
                        };
                    } else if (type === 'language') {
                        const randomQuestion = languageQuestions[Math.floor(Math.random() * languageQuestions.length)];
                        fallbackQuestion = {
                            id: `lang_${Date.now()}`,
                            type: 'language',
                            question: randomQuestion.question,
                            options: randomQuestion.choices,
                            answer: randomQuestion.correctAnswer,
                            explanation: randomQuestion.explanation,
                            difficulty: difficulty
                        };
                    }
                    
                    if (fallbackQuestion) {
                        setCurrentQuestion(fallbackQuestion);
                        setUserAnswer('');
                        setSelectedAnswer('');
                        setShowResult(false);
                        setLastResult(null);
                        // showMessage('å°å­¦1å¹´ç”Ÿãƒ¬ãƒ™ãƒ«ã®å•é¡Œã‚’ç”¨æ„ã—ã¾ã—ãŸ'); // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‰Šé™¤
                    }
                } finally {
                    setLoading(false);
                }
            };

            // AIå•é¡Œç”Ÿæˆé–¢æ•°ï¼ˆç®—æ•°ï¼‰
            const generateMathQuestionWithAI = async (difficulty = 1) => {
                const prompt = `å°å­¦1å¹´ç”Ÿãƒ¬ãƒ™ãƒ«ã®ç®—æ•°å•é¡Œã‚’1ã¤ä½œæˆã—ã¦ãã ã•ã„ã€‚

è¦ä»¶:
- æ•°å­—ã¯1ã‹ã‚‰10ã¾ã§ã®ç¯„å›²
- è¶³ã—ç®—ã‹å¼•ãç®—ã®ã¿
- çµæœã¯0ã‹ã‚‰20ã®ç¯„å›²å†…
- æ—¥æœ¬èªã§å•é¡Œæ–‡ã‚’ä½œæˆ
- ç­”ãˆã¯æ•°å­—ã®ã¿

ä»¥ä¸‹ã®JSONå½¢å¼ã§å›ç­”ã—ã¦ãã ã•ã„:
{
    "question": "å•é¡Œæ–‡ (ä¾‹: 3 + 4 = ?)",
    "answer": "æ­£è§£ã®æ•°å­—",
    "explanation": "è§£èª¬ (ä¾‹: 3ã¨4ã‚’è¶³ã™ã¨7ã«ãªã‚Šã¾ã™)"
}`;

                const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=' + GEMINI_API_KEY, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [
                            {
                                parts: [
                                    {
                                        text: prompt
                                    }
                                ]
                            }
                        ],
                        generationConfig: {
                            temperature: 0.7,
                            topK: 20,
                            topP: 0.8,
                            maxOutputTokens: 200
                        }
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Math API Error:', errorData);
                    throw new Error(`AIå•é¡Œç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                console.log('Math AI Response:', data);
                const text = data.candidates[0].content.parts[0].text;
                
                // JSONéƒ¨åˆ†ã‚’æŠ½å‡º
                const jsonMatch = text.match(/\{[\s\S]*\}/);
                if (!jsonMatch) {
                    throw new Error('AIå¿œç­”ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
                const questionData = JSON.parse(jsonMatch[0]);
                
                return {
                    id: `math_${Date.now()}`,
                    type: 'math',
                    question: questionData.question,
                    answer: questionData.answer,
                    explanation: questionData.explanation,
                    difficulty: difficulty
                };
            };

            // AIå•é¡Œç”Ÿæˆé–¢æ•°ï¼ˆå›½èªï¼‰
            const generateLanguageQuestionWithAI = async (difficulty = 1) => {
                const prompt = `å°å­¦1å¹´ç”Ÿãƒ¬ãƒ™ãƒ«ã®å›½èªå•é¡Œã‚’1ã¤ä½œæˆã—ã¦ãã ã•ã„ã€‚

è¦ä»¶:
- ã²ã‚‰ãŒãªãƒ»ã‚«ã‚¿ã‚«ãƒŠã®ã¿ï¼ˆæ¼¢å­—ã¯ä½¿ç”¨ç¦æ­¢ï¼‰
- ã²ã‚‰ãŒãªã‚’ã‚«ã‚¿ã‚«ãƒŠã«å¤‰æ›ã™ã‚‹å•é¡Œ
- å‹•ç‰©ã€é£Ÿã¹ç‰©ã€æ—¥ç”¨å“ãªã©ã®ç°¡å˜ãªå˜èª
- 5ã¤ã®é¸æŠè‚¢ã‚’æä¾›
- æ­£è§£ã¯1ã¤ã ã‘

ä»¥ä¸‹ã®JSONå½¢å¼ã§å›ç­”ã—ã¦ãã ã•ã„:
{
    "question": "å•é¡Œæ–‡ (ä¾‹: ã€Œã„ã¬ã€ã‚’ã‚«ã‚¿ã‚«ãƒŠã§æ›¸ãã¨ï¼Ÿ)",
    "choices": ["é¸æŠè‚¢1", "é¸æŠè‚¢2", "é¸æŠè‚¢3", "é¸æŠè‚¢4", "é¸æŠè‚¢5"],
    "correctAnswer": "æ­£è§£ã®é¸æŠè‚¢",
    "explanation": "è§£èª¬ (ä¾‹: ã„ã¬ã¯ã‚«ã‚¿ã‚«ãƒŠã§ã‚¤ãƒŒã¨æ›¸ãã¾ã™)"
}`;

                const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=' + GEMINI_API_KEY, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [
                            {
                                parts: [
                                    {
                                        text: prompt
                                    }
                                ]
                            }
                        ],
                        generationConfig: {
                            temperature: 0.7,
                            topK: 20,
                            topP: 0.8,
                            maxOutputTokens: 300
                        }
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Language API Error:', errorData);
                    throw new Error(`AIå•é¡Œç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                console.log('Language AI Response:', data);
                const text = data.candidates[0].content.parts[0].text;
                
                // JSONéƒ¨åˆ†ã‚’æŠ½å‡º
                const jsonMatch = text.match(/\{[\s\S]*\}/);
                if (!jsonMatch) {
                    throw new Error('AIå¿œç­”ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
                const questionData = JSON.parse(jsonMatch[0]);
                
                return {
                    id: `lang_${Date.now()}`,
                    type: 'language',
                    question: questionData.question,
                    options: questionData.choices,
                    answer: questionData.correctAnswer,
                    explanation: questionData.explanation,
                    difficulty: difficulty
                };
            };



            const submitAnswer = async (answer) => {
                try {
                    setLoading(true);
                    
                    // Ensure user exists in the server before submitting answer
                    if (!currentUser || !currentUser.id) {
                        throw new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    }
                    
                    // Check if user exists on server, if not create it
                    console.log('Checking user existence for ID:', currentUser.id);
                    const checkUserResponse = await fetch(`/api/users/${currentUser.id}`);
                    console.log('Check user response status:', checkUserResponse.status);
                    
                    if (!checkUserResponse.ok) {
                        console.log('User does not exist on server, creating...');
                        // User doesn't exist on server, create it
                        const createUserResponse = await fetch('/api/users', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                name: currentUser.name,
                                totalScore: currentUser.totalScore || 0,
                                mathScore: currentUser.mathScore || 0,
                                languageScore: currentUser.languageScore || 0,
                                currentRank: currentUser.currentRank || 'bronze',
                                rewards: currentUser.rewards || []
                            })
                        });
                        
                        if (createUserResponse.ok) {
                            const newUser = await createUserResponse.json();
                            setCurrentUser(newUser);
                            localStorage.setItem('currentUser', JSON.stringify(newUser));
                            console.log('Recreated user on server:', newUser);
                        } else {
                            console.error('Failed to create user on server:', createUserResponse.status);
                        }
                    } else {
                        console.log('User exists on server');
                    }
                    
                    // Ensure question exists in database before submitting answer
                    console.log('Ensuring question exists in database...');
                    const ensureQuestionResponse = await fetch('/api/questions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            id: currentQuestion.id,
                            type: currentQuestion.type,
                            question: currentQuestion.question,
                            answer: currentQuestion.answer,
                            choices: currentQuestion.options || [],
                            difficulty: currentQuestion.difficulty || 1
                        })
                    });
                    
                    if (ensureQuestionResponse.ok) {
                        console.log('Question ensured in database');
                    } else {
                        console.warn('Failed to ensure question in database, but continuing');
                    }
                    
                    // Submit answer to database via API
                    const response = await fetch('/api/answers', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            userId: currentUser.id,
                            questionId: currentQuestion.id,
                            userAnswer: answer
                        })
                    });
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('API Error Response:', errorText);
                        console.error('Question ID:', currentQuestion.id);
                        console.error('User ID:', currentUser.id);
                        throw new Error(`å›ç­”ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: ${response.status} - ${errorText}`);
                    }
                    
                    const result = await response.json();
                    
                    // Update current user with the returned user data
                    setCurrentUser(result.user);
                    
                    // Save updated user to localStorage
                    localStorage.setItem('currentUser', JSON.stringify(result.user));
                    
                    setLastResult(result);
                    setShowResult(true);
                    
                    if (result && result.answer && result.answer.isCorrect) {
                        // showMessage(`æ­£è§£ï¼ ${result.scoreIncrement || 10}ãƒã‚¤ãƒ³ãƒˆç²å¾—`); // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‰Šé™¤
                        
                        // Check for rank up
                        if (result.rankUp) {
                            // showMessage('ãƒ©ãƒ³ã‚¯ã‚¢ãƒƒãƒ—ã—ã¾ã—ãŸï¼'); // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‰Šé™¤
                        }
                        
                        // Check for new rewards
                        if (result.newRewards && result.newRewards.length > 0) {
                            result.newRewards.forEach(reward => {
                                // showMessage(`æ–°ã—ã„ç‰¹å…¸ã‚’ç²å¾—: ${reward.name} ${reward.icon}`); // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‰Šé™¤
                            });
                        }
                    } else {
                        // showMessage('ä¸æ­£è§£ã§ã™', 'error'); // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‰Šé™¤
                    }
                } catch (err) {
                    console.error('Submit answer error:', err);
                    console.error('Error details:', err.message);
                    showMessage('å›ç­”å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message, 'error');
                } finally {
                    setLoading(false);
                }
            };
            
            const logoutUser = () => {
                localStorage.removeItem('currentUser');
                localStorage.removeItem('userProgress');
                setCurrentUser(null);
                setCurrentPage('home');
                setCurrentQuestion(null);
                setUserAnswer('');
                setSelectedAnswer('');
                setShowResult(false);
                setLastResult(null);
                // showMessage('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ'); // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‰Šé™¤
            };
            
            const resetUserData = () => {
                if (currentUser && window.confirm('æœ¬å½“ã«ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                    const resetUser = {
                        ...currentUser,
                        totalScore: 0,
                        mathScore: 0,
                        languageScore: 0,
                        rank: 'åˆå¿ƒè€…',
                        currentRank: 'bronze',
                        rewards: []
                    };
                    
                    setCurrentUser(resetUser);
                    localStorage.setItem('currentUser', JSON.stringify(resetUser));
                    localStorage.setItem('userProgress', JSON.stringify({
                        userId: currentUser.id,
                        totalScore: 0,
                        mathScore: 0,
                        languageScore: 0,
                        rank: 'åˆå¿ƒè€…',
                        answeredQuestions: [],
                        lastUpdated: new Date().toISOString()
                    }));
                    
                    showMessage('ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
                }
            };

            const HomePage = () => {
                const [userName, setUserName] = useState('');
                const [password, setPassword] = useState('');
                const [isLogin, setIsLogin] = useState(false);

                const handleSubmit = (e) => {
                    e.preventDefault();
                    if (userName.trim() && password.trim()) {
                        if (isLogin) {
                            loginUser(userName.trim(), password.trim());
                        } else {
                            createUser(userName.trim(), password.trim());
                        }
                    }
                };

                if (currentUser) {
                    return (
                        <div>
                            <div className="welcome-card">
                                <h1>ãŠã‹ãˆã‚Šãªã•ã„ã€{currentUser.name}ã•ã‚“ï¼</h1>
                                <p>ä»Šæ—¥ã‚‚ä¸€ç·’ã«å­¦ç¿’ã—ã¾ã—ã‚‡ã† âœ¨</p>
                            </div>
                            
                            <div className="stats-card">
                                <h2>{currentUser.name}</h2>
                                <p>ç·åˆã‚¹ã‚³ã‚¢: {currentUser.totalScore}</p>
                                <p>ãƒ©ãƒ³ã‚¯: {currentUser.rank}</p>
                            </div>

                            <div className="grid">
                                <div className="feature-card">
                                    <h3>ğŸ§® ç®—æ•°</h3>
                                    <p>ã‚¹ã‚³ã‚¢: {currentUser.mathScore}</p>
                                    <p>ãƒ†ãƒ³ã‚­ãƒ¼ã‚’ä½¿ã£ã¦è¨ˆç®—å•é¡Œã‚’è§£ãã¾ã—ã‚‡ã†</p>
                                    <button className="primary-button" onClick={() => setCurrentPage('math')}>
                                        ç®—æ•°å•é¡Œã‚’è§£ã
                                    </button>
                                </div>
                                
                                <div className="feature-card">
                                    <h3>ğŸ“š å›½èª</h3>
                                    <p>ã‚¹ã‚³ã‚¢: {currentUser.languageScore}</p>
                                    <p>5ã¤ã®é¸æŠè‚¢ã‹ã‚‰æ­£ã—ã„ç­”ãˆã‚’é¸ã³ã¾ã—ã‚‡ã†</p>
                                    <button className="primary-button" onClick={() => setCurrentPage('language')}>
                                        å›½èªå•é¡Œã‚’è§£ã
                                    </button>
                                </div>
                            </div>
                            
                            <div className="feature-card" style={{marginTop: '2rem', textAlign: 'center'}}>
                                <button className="secondary-button" onClick={logoutUser}>
                                    ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                                </button>
                            </div>
                        </div>
                    );
                }

                return (
                    <div>
                        <div className="welcome-card">
                            <h1>å­¦ç¿’ã‚¢ãƒ—ãƒªã¸ã‚ˆã†ã“ãï¼</h1>
                            <p>ç®—æ•°ã¨å›½èªã®å•é¡Œã§æ¥½ã—ãå­¦ç¿’ã—ã¾ã—ã‚‡ã† ğŸ“</p>
                        </div>

                        <div className="feature-card" style={{maxWidth: '500px', margin: '0 auto'}}>
                            <h2>ğŸ‘¤ {isLogin ? 'ãƒ­ã‚°ã‚¤ãƒ³' : 'æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²'}</h2>
                            <p>{isLogin ? 'åå‰ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„' : 'åå‰ã¨4æ¡ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'}</p>
                            
                            <form onSubmit={handleSubmit}>
                                <input 
                                    type="text" 
                                    value={userName}
                                    onChange={(e) => setUserName(e.target.value)}
                                    placeholder="ã‚ãªãŸã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"
                                    className="input-field"
                                    required
                                />
                                <input 
                                    type="password" 
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    placeholder="4æ¡ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"
                                    className="input-field"
                                    maxLength="4"
                                    pattern="[0-9]{4}"
                                    title="4æ¡ã®æ•°å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"
                                    required
                                />
                                <button type="submit" className="primary-button" disabled={loading}>
                                    {loading ? (isLogin ? 'ãƒ­ã‚°ã‚¤ãƒ³ä¸­...' : 'ç™»éŒ²ä¸­...') : (isLogin ? 'ãƒ­ã‚°ã‚¤ãƒ³' : 'æ–°è¦ç™»éŒ²')}
                                </button>
                            </form>
                            
                            <div style={{marginTop: '1rem', textAlign: 'center'}}>
                                <button 
                                    type="button" 
                                    className="secondary-button"
                                    onClick={() => setIsLogin(!isLogin)}
                                >
                                    {isLogin ? 'æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²' : 'æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ãƒ­ã‚°ã‚¤ãƒ³'}
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };

            const MathPage = () => {
                const addNumber = (num) => {
                    setUserAnswer(prev => prev + num);
                };

                const clearAnswer = () => {
                    setUserAnswer('');
                };

                const backspace = () => {
                    setUserAnswer(prev => prev.slice(0, -1));
                };

                const handleSubmit = () => {
                    if (userAnswer.trim() && !loading && !showResult) {
                        submitAnswer(userAnswer.trim());
                    }
                };

                return (
                    <div className="math-container">
                        <div className="welcome-card" style={{padding: '0.5rem', margin: '0.2rem 0'}}>
                            <h1 style={{margin: '0', fontSize: '1.3rem'}}>ğŸ§® ç®—æ•°å•é¡Œ</h1>
                        </div>

                        <div className="math-grid">
                            <div className="feature-card" style={{padding: '0.8rem', margin: '0.2rem 0'}}>
                                <h3 style={{margin: '0 0 0.3rem 0', fontSize: '1.1rem'}}>å•é¡Œ</h3>
                                {!currentQuestion ? (
                                    <button className="primary-button" onClick={() => generateQuestion('math', 1)}>
                                        {loading ? 'ç”Ÿæˆä¸­...' : 'æ–°ã—ã„å•é¡Œã‚’ç”Ÿæˆ'}
                                    </button>
                                ) : (
                                    <div className="question-area">
                                        <div className="question-card" style={{padding: '0.8rem', margin: '0.2rem 0'}}>
                                            <h2 style={{margin: '0 0 0.3rem 0', fontSize: '1.2rem'}}>{currentQuestion.question}</h2>
                                            <div style={{fontSize: '1.1rem', margin: '0.3rem 0', border: '2px solid #e2e8f0', padding: '0.4rem', borderRadius: '8px', minHeight: '1.8rem'}}>
                                                {userAnswer || 'ç­”ãˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'}
                                            </div>
                                            
                                            {showResult && (
                                                <div style={{marginTop: '0.5rem', padding: '0.8rem', backgroundColor: lastResult?.answer?.isCorrect ? '#f0fff4' : '#fee', borderRadius: '8px'}}>
                                                    <h3 style={{margin: '0 0 0.3rem 0', fontSize: '1.1rem'}}>{lastResult?.answer?.isCorrect ? 'æ­£è§£ï¼' : 'ä¸æ­£è§£'}</h3>
                                                    <p style={{margin: '0.2rem 0', fontSize: '0.9rem'}}>æ­£è§£: {currentQuestion.answer}</p>
                                                    {lastResult?.answer?.isCorrect && <p style={{margin: '0.2rem 0', fontSize: '0.9rem'}}>ç²å¾—ãƒã‚¤ãƒ³ãƒˆ: {lastResult.scoreIncrement}</p>}
                                                    <button className="primary-button" onClick={() => generateQuestion('math', 1)} style={{marginTop: '0.5rem', padding: '0.6rem 1rem', fontSize: '0.9rem'}}>
                                                        æ¬¡ã®å•é¡Œ
                                                    </button>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                )}
                            </div>

                            <div className="feature-card" style={{padding: '0.8rem', margin: '0.2rem 0'}}>
                                <div className="numpad">
                                    {[1,2,3,4,5,6,7,8,9,'C',0,'âŒ«'].map(btn => (
                                        <button 
                                            key={btn} 
                                            onClick={() => {
                                                if (btn === 'C') clearAnswer();
                                                else if (btn === 'âŒ«') backspace();
                                                else addNumber(btn.toString());
                                            }}
                                            disabled={showResult}
                                        >
                                            {btn}
                                        </button>
                                    ))}
                                </div>
                                <button className="primary-button" onClick={handleSubmit} disabled={!userAnswer || loading || showResult} style={{marginTop: '0.5rem', padding: '0.6rem 1rem', fontSize: '0.9rem', opacity: (!userAnswer || loading || showResult) ? '0.5' : '1'}}>
                                    {loading ? 'é€ä¿¡ä¸­...' : 'å›ç­”ã™ã‚‹'}
                                </button>
                            </div>
                        </div>

                        <button className="primary-button" onClick={() => setCurrentPage('home')} style={{marginTop: '0.5rem', padding: '0.6rem 1rem', fontSize: '0.9rem'}}>
                            ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹
                        </button>
                    </div>
                );
            };

            const LanguagePage = () => {
                const handleSubmit = () => {
                    if (selectedAnswer && !loading && !showResult) {
                        submitAnswer(selectedAnswer);
                    }
                };

                return (
                    <div>
                        <div className="welcome-card" style={{padding: '1rem', margin: '0.5rem 0'}}>
                            <h1 style={{margin: '0', fontSize: '1.5rem'}}>ğŸ“š å›½èªå•é¡Œ</h1>
                        </div>

                        <div className="feature-card" style={{padding: '1rem', margin: '0.5rem 0'}}>
                            <h3 style={{margin: '0 0 0.5rem 0', fontSize: '1.2rem'}}>å•é¡Œ</h3>
                            {!currentQuestion ? (
                                <button className="primary-button" onClick={() => generateQuestion('language', 1)}>
                                    {loading ? 'ç”Ÿæˆä¸­...' : 'æ–°ã—ã„å•é¡Œã‚’ç”Ÿæˆ'}
                                </button>
                            ) : (
                                <div className="question-card" style={{padding: '1rem', margin: '0.5rem 0'}}>
                                    <h2 style={{margin: '0 0 0.5rem 0', fontSize: '1.3rem'}}>{currentQuestion.question}</h2>
                                    
                                    {(currentQuestion.options || currentQuestion.choices || []).map((option, index) => (
                                        <button
                                            key={index}
                                            className={`choice-button ${selectedAnswer === option ? 'selected' : ''}`}
                                            onClick={() => setSelectedAnswer(option)}
                                            disabled={showResult}
                                        >
                                            {option}
                                        </button>
                                    ))}
                                    
                                    <button className="primary-button" onClick={handleSubmit} disabled={!selectedAnswer || loading || showResult} style={{marginTop: '1rem', opacity: (!selectedAnswer || loading || showResult) ? '0.5' : '1'}}>
                                        {loading ? 'é€ä¿¡ä¸­...' : 'å›ç­”ã™ã‚‹'}
                                    </button>
                                    
                                    {showResult && (
                                        <div style={{marginTop: '1rem', padding: '1rem', backgroundColor: lastResult?.answer?.isCorrect ? '#f0fff4' : '#fee', borderRadius: '8px'}}>
                                            <h3>{lastResult?.answer?.isCorrect ? 'æ­£è§£ï¼' : 'ä¸æ­£è§£'}</h3>
                                            <p>æ­£è§£: {currentQuestion.answer}</p>
                                            {lastResult?.answer?.isCorrect && <p>ç²å¾—ãƒã‚¤ãƒ³ãƒˆ: {lastResult.scoreIncrement}</p>}
                                            <button className="primary-button" onClick={() => generateQuestion('language', 1)} style={{marginTop: '1rem'}}>
                                                æ¬¡ã®å•é¡Œ
                                            </button>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>

                        <button className="primary-button" onClick={() => setCurrentPage('home')} style={{marginTop: '2rem'}}>
                            ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹
                        </button>
                    </div>
                );
            };

            const renderPage = () => {
                switch(currentPage) {
                    case 'math': return <MathPage />;
                    case 'language': return <LanguagePage />;
                    default: return <HomePage />;
                }
            };

            return (
                <div className="app-container">
                    {renderPage()}
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>